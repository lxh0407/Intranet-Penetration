#内网知识基础

###内网概述

- **内网一般指局域网**（Local Area Network,LAN）即在某一区域内由多台计算机互联成的计算机组。一般是方圆几千米之内。内网（局域网）可以实现文件管理、应用软件共享、打印机共享等功能，在使用过程当中，通过维护内网（局域网）网络安全，能够有效地保护资料安全，保证内网（局域网）网络能够正常稳定的运行。

- **内网是封闭型的**，它可以由办公室的两台计算机组成，也可以由一个公司内的上千台计算机组成。例如银行、学校、政府机关、网吧等都属于此类。

- 研究内网时会遇到很多专有名词都需要由一定的认识。如下......

### 专有名词

##### 工作组

- **工作组(Work Group)：是最常见最简单最普通的资源管理模式，就是将不同的电脑按功能分别列入不同的组中，**以方便管理。比如在一个网络内，可能有成百上千台工作电脑，如果这些电脑不进行分组，都列在“网上邻居”内，可想而知会有多么乱。比如一所高校，会分为诸如数学系、中文系之类的，然后数学系的电脑全都列入数学系的工作组中，中文系的电脑全部都列入到中文系的工作组中……如果你要访问某个系别的资源，就在“网上邻居”里找到那个系的工作组名，双击就可以看到那个系别的电脑了。

#####域

- **域（Domain）是一个有安全边界（安全边界指两个域中，一个域中的计算机不能访问另一个域中的资源）的计算机集合，**在同一个域中的计算机彼此之间已经建立了**信任关系**，在域内访问其他机器，不再需要被访问机器的许可。相比工作组而言它有一个**更加严格的安全管理控制机制**，如果你想访问域内资源，必须由一个合法身份登入域，而对域由什么样的权限，需要取决于你登入域的用户身份。**域可以看做升级版的工作组。**

- **域控制器（Domain Controller，DC）是一个域中的一台类似管理服务器的计算机，**负责每一台计算机的连入和用户验证工作，域内电脑如果想互相访问首先都是经过它的审核。

- 域的分类：单域、父域、子域、域树、域森林、DNS（域名服务器）

  ------

  

#####单域

- **一般在有固定地理位置的小公司，一个域就能满足需求。**
- **一般在一个域中至少建立两个域服务器，一个作为DC，一个是备份DC。**一但DC瘫痪，域内其他用户不能登入该域，因为活动目录的数据库是存储在DC中的。而有另一台**备份域控制器（BDC）**,至少该域能正常使用。

#####父域

- 出于管理及其他一些需求，需要在网络中划分多个域，**第一个域称为父域**，**各分部的域称为子域**。
- 比如一个大公司，它的不同分公司在不同的地理位置，则需要父域及子域 这样的结构。
- 如果不同地理位置的分公司放在同一个域内，那么他们之间信息交互（包括同步、复制等）所花费的时间会比较长，而且占用的带宽也比较大。（因为在同一个域中，信息交互的条目是很多的，而且不压缩；在域和域之间，信息交互的条目相对较少，而且压缩）且子公司可以通过自己的域来**管理**自己的资源。
- 还有一种出于**安全策略**的考虑，因为每个域都有自己独有的安全策略，比如一个公司的财务部门希望能使用特点的安全策略（包括账号密码等策略），那么可以将财务部门做成一个子域来单独管理。

#####域树

- 域树指若干个域通过**建立信任关系**组成的集合。一个域管理员只能管理本域的内部，不能访问或者管理其他域，**两个域之间访问则需要建立信任关系。**
- **信任关系是连接在域和域之间的桥梁**，域树内的父域和子域之间不但可以按需要互相进行管理，还可以跨网分配文件和打印机等设备资源，使不同域之间实现网络资源的共享与管理，以及相互通信和数据传输。
- 在一个域树内，父域可以包含很多子域，子域是相对父域来说的，子域名中的每一个段。**子域只能使用父域做为域名后缀**，也就是说在一个域树中，域的名字是连续的。
![1.jpg](https://i.loli.net/2021/05/19/nkZBOc9QsRmgo2d.jpg)

##### 域森林

- **域森林指若干个域树通过建立信任关系组成的集合。**可以通过域树之间建立的信任关系来管理和使用整个森林的资源，而又保持了原有域自身原有的特性。

#####DNS域名服务器

- **DNS（Domain Name Server，域名服务器）是进行域名(domain name)和与之相对应的IP地址 (IP address)转换的服务器**。

- 在域树介绍中，看到域树中的域的名字和DNS域的名字非常相似，实际上**域的名字就是DNS域的名字**，因为域中的计算机使用DNS来定位域控制器（DC）和服务器以及其他计算机、网络服务等。

- 一般情况下，我们在**内网渗透时就通过寻找DNS服务器来定位域控制器**，因为通常DNS服务器和域控制器会处于同一台机器上。

  ------

  

##### 活动目录

- 活动目录（Active Directory）是**域环境中提供目录服务的组件**。

- 目录就是**存储有关网络对象**（如用户、组、计算机、公共资源、打印机和联系人等）**的信息**。**目录服务**就是帮助用户快速准确的从目录中**查找到**他所需要的信息的服务。

- 把企业看成一本字典，那么内网资源就是字典的内容，活动目录就相当于字典的**索引**。即活动目录存储的是网络中**所有资源的快捷方式**，用户通过寻找快捷方式而定位资源。

  ------

  

##### 逻辑结构

- 在活动目录中，管理员可以**完全忽略被管理对象的具体地理位置**，而将这些对象**按照一定的方式放置在不同的容器中**。由于这种组织对象的做法不考虑被管理对象的具体地理位置，这种组织框架称为“**逻辑结构**”。

- **活动目录的逻辑结构**就包括上面讲到的**组织单元（OU）、域（Domain）、域树（tree）、域森林（forest）**。在域树内的所有域**共享一个活动目录**，这个活动目录内的**数据分散的存储在各个域内**，且每一个域只存储该域内的数据。

#####活动目录主要功能

- **账号集中管理**，所有账号均存在服务器上，方便对账号的重命名/重置密码。

- **软件集中管理**，统一推送软件，统一安装网络打印机等。利用软件发布策略分发软件，可以让用户自由选择安装软件。

- **环境集中管理**，利用AD可以统一客户端桌面，IE、TCP/IP等设置。

- **增强安全性**，统一部署杀毒软件和扫毒任务，**集中化管理用户的计算机权限**，统一定制用户密码策略等，可监控网络，资料统一管理。

- **更可靠、更少的宕机时间**。如：利用AD控制用户访问权限，利用群集、负载均衡等技术对文件服务器进行容灾设定。

- **活动目录为Microsoft统一管理的基础平台**，其他isa，exchange，sms等服务否依赖于这个基础平台。

  ------

#####AD和DC的区别

- 如果网络规模较大，我们就会把网络中的众多对象：计算机、用户、用户组、打印机、共享文件等，分门别类、井然有序的放在一个大仓库中，并做好检索信息，便于查找、管理和使用这些对象（资源）。**这个有层次结构的数据库，就是活动目录数据库，简称AD库。**
- 我们把**存放有活动目录数据库的计算机称为DC**。所以我们要实现域环境就是要安装AD，当内网中的一台计算机安装了AD后，它就是DC。

#####安全域划分

- 安全域划分的目的是**将一组安全等级相同的计算机划入同一个网段内**，这一网段内的计算机拥有相同的**网络边界**，在**网络边界上采用防火墙部署**来实现对**其他安全域的NACL（网络访问控制策略）**，允许哪些IP访问此域、不允许哪些访问此域；允许此域访问哪些IP/网段、不允许访问哪些IP/网段。**使得其风险最小化**，当发生攻击时可以将威胁最大化的隔离，减少对域内计算机的影响。

![2.JPG](https://i.loli.net/2021/05/20/IijcG1HpKJoqe5f.jpg)

##### DMZ

- DMZ，（Demilitarized Zone），中文名称为“隔离区”，也称“非军事化区”。它是为了**解决安装防火墙后外部网络的访问用户不能访问内部网络服务器的问题**，而设立的一个**非安全系统与安全系统之间的缓冲区**。

- 该**缓冲区位于企业内部网络和外部网络之间的小网络区域内**。在这个小网络区域内可以放置一些**必须公开的服务器设施**，如企业Web服务器、FTP服务器和论坛等。

- 另一方面，通过这样一个DMZ区域，**更加有效地保护了内部网络**。因为这种网络部署，比起一般的防火墙方案，对来自外网的攻击者来说又多了一道关卡。

  ------

##### DMZ的屏障功能

一个用路由器连接的局域网中,我们可以将网络划分为**三个区域**：**安全级别最高的LAN Area（内网）**,**安全级别中等的DMZ区域**和**安全级别最低的Internet区域（外网）**。三个区域因担负不同的任务而拥有不同的访问策略。我们在配置一个拥有DMZ区的网络的时候**通常定义以下的访问控制策略以实现DMZ区的屏障功能**。

- **内网可以访问外网**
  内网的用户显然需要自由地访问外网。在这一策略中，**防火墙需要进行源地址转换**（NAT）。
- **内网可以访问DMZ**
  此策略是为了**方便内网用户使用和管理DMZ中的服务器**。
- **外网不能访问内网**
  很显然，内网中存放的是公司内部数据，这些数据不允许外网的用户进行访问。
- **外网可以访问DMZ**
  **DMZ中的服务器**本身就是要**给外界提供服务**的，所以**外网必须可以访问DMZ**。同时，外网访问DMZ需要由防火墙完成对**外地址到服务器实际地址的转换**。
- **DMZ访问内网有限制**
  很明显，如果违背此策略，则当入侵者攻陷DMZ时，就可以进一步进攻到内网的重要数据。
- **DMZ不能访问外网**
  此条策略也有**例外**，比如DMZ中放置邮件服务器时，就需要访问外网，否则将不能正常工作。在网络中，非军事区(DMZ)是指**为不信任系统提供服务的孤立网段**，其目的是把敏感的内部网络和其他提供访问服务的网络分开，**阻止内网和外网直接通信**，以保证内网安全。

------

##### 域中计算机分类

- **域控制器**：**DC是存放活动目录数据库的，必须存在**，而其他三种不是必须存在的。如果一个域只有一台计算机，那么这台计算机就是该域的域控制器。计算机的角色也是可以改变的。
- **成员服务器**
- **客户机**
- **独立服务器**

##### 内权限解读

- **域本地组**，**多域用户访问单域资源**（访问同一个域）。可以从任何一个域添加用户账户、通用组和全局域，但只能在其所在域内指派权限。**域本地组不能嵌套域其他组中**。它主要是用于**授予位于本域资源的访问权限**。

- **全局组**：**单域用户访问多域资源**（必须是同一个域里的用户）。只能在**创建该全局组的域上**进行添加用户和全局组，可以在**域林中的任何域中指派权限**，全局组可以嵌套在其他组中。

- **通用组**：**通用组成员来自域森林中任何域中的用户账户、全局组和其他的通用组**，可以在该**域林中的任何域中指派权限**，可以**嵌套域其他域组中**。适合**域林中的跨域访问**。

- **域本地组**：来自全林（权限）用于本域     **全局组**：来自本域作用于全林      **通用组**：来自全林用于全林

##### A-G-DL-P策略

- A(Account):用户账号
- G(Global Group):表示全局组
- U(Universal Group):表示通用组
- DL(Domain Local Group):表示域本地组
- P(Permission):表示资源权限
- A-G-DL-P策略是将**用户账号添加到全局组中**，将**全局组添加到域本地组中**，**然后为域本地组分配资源权限**。按照A-G-DL-P的原则对用户进行组织和管理起来更容易。
- 在A-G-DL-P形成以后**给一个用户某一个权限**的时候，只要把这个**用户加入到某一个本地域组**就可以了。

  

------

##### 本地域组的权限

- **Administrators（管理员组）**
- Remote Desktop Users（远程登录组）
- Print  Operators（打印机操作员组）
- Account Operators（账号操作员组）
- Server Operators（服务器操作员组）
- Backup Operators（备份操作员组）

##### 全局组、通用组权限

- **Domain Admins（域管理员组）**
- **Enterprise Admins（企业系统管理员组）**
- **Schema Admins（构架管理员组）**
- Domain Users（域用户组）